import streamlit as st
import random

# ==========================================
# 1. 跨越黑潮：擴充版全學段資料庫 (3 Topics per Grade)
# ==========================================
# 結構：年級 -> [主題1資料, 主題2資料, 主題3資料]
full_lesson_db = {
    "國中七年級 (生物/科學觀察)": [
        {
            "topic_name": "主題 A：海上的仿生學 (結構與功能)",
            "課綱重點": "生物體的構造與功能、仿生設計",
            "核心概念": "蟹爪帆 vs 螃蟹螯：生物結構的抗風智慧",
            "versions": {
                "Ver. A 標準探究版": "### 🧪 仿生學：海上的螃蟹螯\n**目標**：觀察生物構造如何應用於科技。\n\n#### I. 引起動機\n* 展示螃蟹螯與蟹爪帆對比圖。\n* 提問：為何帆要做成這種形狀？\n\n#### II. 實作\n* 風洞模擬：比較方形葉片與蟹爪葉片的抗風性。\n\n#### III. 結論\n* 原住民向大自然學習的智慧。",
                "Ver. B 硬派實作版": "### 🛠️ 黑潮造船師：尋找最強結構\n**目標**：試誤法找出抗風結構。\n\n#### I. 挑戰\n* 材料限制：報紙、吸管。打造不被吹翻的帆。\n\n#### II. 過程\n* 第一輪：平面帆(失敗)。\n* 第二輪：模仿生物結構修剪(成功)。",
                "Ver. C 深度文化版": "### 🌊 祖先的眼睛：閱讀海洋\n**目標**：理解原住民族自然觀。\n\n#### I. 體驗\n* 講述蟹爪帆傳說。\n* 手作編織林投葉帆模型，進行祈福下水儀式。"
            }
        },
        {
            "topic_name": "主題 B：漂流的種子 (傳播與繁衍)",
            "課綱重點": "生物的生殖與繁衍、種子的傳播",
            "核心概念": "像椰子一樣旅行：黑潮上的飄浮物",
            "versions": {
                "Ver. A 標準探究版": "### 🥥 海上的旅行者\n**目標**：探討海漂植物的構造。\n\n#### I. 觀察\n* 剖開椰子或棋盤腳，觀察其中空的纖維構造。\n\n#### II. 實驗\n* 測試不同植物構造的浮力持久度。",
                "Ver. B 硬派實作版": "### 📦 物資空投：防水包裹挑戰\n**目標**：設計能長時間漂浮的防水結構。\n\n#### I. 任務\n* 保護一顆方糖在水中漂浮 10 分鐘不溶化。\n* 失敗：方糖溶化(貨物損毀)。",
                "Ver. C 深度文化版": "### 🌱 帶著家鄉去旅行\n**目標**：南島語族的遷徙植物文化。\n\n#### I. 故事\n* 祖先船上帶了什麼種子(麵包樹/構樹)？\n* 這些植物如何連結整個南島世界？"
            }
        },
        {
            "topic_name": "主題 C：游得快還是游得穩？ (流線與阻力)",
            "課綱重點": "生物對環境的適應、科學方法",
            "核心概念": "飛魚與鬼頭刀：流體阻力的演化賽局",
            "versions": {
                "Ver. A 標準探究版": "### 🐟 水中的賽車\n**目標**：探討流線型對降低阻力的影響。\n\n#### I. 實驗\n* 在水槽中拖曳不同形狀的黏土(圓形/水滴形)，測量彈簧秤讀數。",
                "Ver. B 硬派實作版": "### 🏎️ 極速黑潮：減阻大賽\n**目標**：利用削減法優化船體。\n\n#### I. 競速\n* 同樣動力，誰跑最快？\n* 透過不斷切削保麗龍船底來降低水阻。",
                "Ver. C 深度文化版": "### 🛶 獨木舟的曲線\n**目標**：阿美族獨木舟的美學與科學。\n\n#### I. 賞析\n* 觀察傳統獨木舟的船首設計。\n* 討論：為什麼老人家說這樣的線條才「順」？"
            }
        }
    ],
    
    "國中八年級 (浮力/基本力學)": [
        {
            "topic_name": "主題 A：不倒翁的秘密 (重心與平衡)",
            "課綱重點": "力與平衡、重心",
            "核心概念": "船為什麼不會翻？重心位置的關鍵",
            "versions": {
                "Ver. A 標準探究版": "### ⚖️ 海上平衡術\n**目標**：探討重心對穩定性的影響。\n\n#### I. 實驗\n* 比較「重心高」與「重心低」的模型在搖晃水面的回復力。",
                "Ver. B 硬派實作版": "### ⚓ 翻船救援隊\n**目標**：利用配重解決翻覆問題。\n\n#### I. 挑戰\n* 設計一艘「帆很高」但「不會翻」的怪船。\n* 解法：在船底加裝重物(龍骨原理)。",
                "Ver. C 深度文化版": "### 🗿 穩如泰山：部落的平衡哲學\n**目標**：連結物質平衡與心理平衡。\n\n#### I. 隱喻\n* 物理上的「壓艙石」對應到文化中「長老的智慧」。"
            }
        },
        {
            "topic_name": "主題 B：竹子還是木頭？ (密度與浮力)",
            "課綱重點": "密度、阿基米德原理",
            "核心概念": "Fayan竹筏的材料科學：中空結構的奧秘",
            "versions": {
                "Ver. A 標準探究版": "### 🎍 竹筏浮力實驗室\n**目標**：計算不同材料的密度與載重。\n\n#### I. 測量\n* 測量竹管與實木的排水體積與重量。",
                "Ver. B 硬派實作版": "### 🚢 諾亞方舟載重賽\n**目標**：最大化載重量。\n\n#### I. 競賽\n* 用有限的鋁箔紙造船，看誰能載最多硬幣而不沉。",
                "Ver. C 深度文化版": "### 🎋 刺竹的恩賜\n**目標**：阿美族對竹材的應用。\n\n#### I. 採集\n* 認識選竹、殺青、烤彎的傳統工法。"
            }
        },
        {
            "topic_name": "主題 C：海水與淡水 (液體密度)",
            "課綱重點": "液體壓力、浮力",
            "核心概念": "黑潮比較好浮嗎？鹽度對航行的影響",
            "versions": {
                "Ver. A 標準探究版": "### 🧂 雞蛋浮起來了\n**目標**：觀察鹽度對浮力的影響。\n\n#### I. 實驗\n* 在水中加鹽，模擬黑潮的高鹽度環境。",
                "Ver. B 硬派實作版": "### 🌊 潛水艇大作戰\n**目標**：控制物體的沉浮。\n\n#### I. 製作\n* 製作浮沉子(Cartesian diver)，控制其在鹽水中的深度。",
                "Ver. C 深度文化版": "### 💧 生命之水\n**目標**：海洋與河川交會處的文化意義。\n\n#### I. 故事\n* 秀姑巒溪出海口的捕魚文化(淡鹹水交會)。"
            }
        }
    ],

    "國中九年級 (力與運動/力矩)": [
        {
            "topic_name": "主題 A：誰能渡過黑潮？ (向量分解)",
            "課綱重點": "力的合成與分解、力矩",
            "核心概念": "向量分析下的黑潮生存戰",
            "versions": {
                "Ver. A 標準探究版": "### 📐 誰能活著渡過黑潮？\n**目標**：向量分解解釋帆受力。\n\n#### I. 推演\n* 畫出風力向量，分解為推力與側向力。\n\n#### II. 驗證\n* 比較方帆與蟹爪帆的側向分力。",
                "Ver. B 硬派實作版": "### ⚙️ 黑潮創客：工程師逆襲\n**目標**：試誤法與反脆弱。\n\n#### I. 過程\n* 第一輪全體翻船(力矩太大)。\n* 第二輪修正為蟹爪帆(縮短力臂)。",
                "Ver. C 深度文化版": "### 🗺️ 解讀風的語言\n**目標**：原住民族世界觀。\n\n#### I. 觀點\n* 西方對抗自然 vs 南島適應自然。"
            }
        },
        {
            "topic_name": "主題 B：風與流的探戈 (相對運動)",
            "課綱重點": "位移、速度、相對運動",
            "核心概念": "船速、風速與流速的向量加法",
            "versions": {
                "Ver. A 標準探究版": "### 🧭 導航向量學\n**目標**：計算船的實際航向。\n\n#### I. 繪圖\n* 已知船速與流速，畫出合速度方向。",
                "Ver. B 硬派實作版": "### 🎯 橫渡黑潮準度賽\n**目標**：修正航道偏差。\n\n#### I. 挑戰\n* 水流向右流，你要怎麼瞄準才能到達正對岸？",
                "Ver. C 深度文化版": "### ✨ 星星導航術\n**目標**：沒有GPS的導航智慧。\n\n#### I. 體驗\n* 認識南島民族如何利用星辰與波浪修正航向。"
            }
        },
        {
            "topic_name": "主題 C：借力使力 (簡單機械)",
            "課綱重點": "槓桿原理、滑輪",
            "核心概念": "如何升起巨大的帆？滑輪與省力",
            "versions": {
                "Ver. A 標準探究版": "### 🏗️ 巨人的力量\n**目標**：探討動滑輪的省力效果。\n\n#### I. 測量\n* 用彈簧秤測量直接拉帆與透過滑輪拉帆的力。",
                "Ver. B 硬派實作版": "### 💪 起重機工程師\n**目標**：設計最省力的升帆系統。\n\n#### I. 製作\n* 用棉線與迴紋針製作滑輪組，挑戰用最少力氣拉起重物。",
                "Ver. C 深度文化版": "### 🤝 Malapaliw (換工)\n**目標**：部落的合作與力學。\n\n#### I. 探討\n* 大家一起拉網/推船的施力位置哲學。"
            }
        }
    ],

    "高中一年級 (向量分析/流體)": [
        {
            "topic_name": "主題 A：渦流升力 (流體動力)",
            "課綱重點": "白努利原理、流體力學",
            "核心概念": "蟹爪帆的空氣動力學：像飛機一樣飛",
            "versions": {
                "Ver. A 標準探究版": "### 🌪️ 隱形的翅膀\n**目標**：探討非傳統帆型的升力。\n\n#### I. 理論\n* 引入「渦流升力」概念，分析氣流分離。",
                "Ver. B 硬派實作版": "### 🚀 極限效率競賽\n**目標**：追求最高升阻比。\n\n#### I. 改造\n* 製作具備流線型斷面的骨架，挑戰極限風速。",
                "Ver. C 深度文化版": "### 🌏 全球南島科學觀\n**目標**：比較維京與南島航海術。\n\n#### I. 比較\n* 北大西洋(順風方帆) vs 太平洋(側風蟹帆)的環境決定論。"
            }
        },
        {
            "topic_name": "主題 B：三角函數的航行 (向量分析)",
            "課綱重點": "平面向量、三角函數",
            "核心概念": "Z字形航行(Tacking)的數學原理",
            "versions": {
                "Ver. A 標準探究版": "### 📐 逆風而行\n**目標**：解析逆風航行的向量分量。\n\n#### I. 計算\n* 計算不同航向角($\\theta$)下的有效推力 $F \\cos\\theta$。",
                "Ver. B 硬派實作版": "### ⛵ 自動導航程式\n**目標**：編寫簡易路徑邏輯。\n\n#### I. 模擬\n* 規劃一條從台東到綠島的最短Z字路徑。",
                "Ver. C 深度文化版": "### 🗿 偉大的航道\n**目標**：南島擴散理論。\n\n#### I. 考古\n* 用數學模型驗證南島語族可能的擴散路徑與時間。"
            }
        },
        {
            "topic_name": "主題 C：波浪的共振 (波動力學)",
            "課綱重點": "波動、共振、阻尼",
            "核心概念": "雙體船(Catamaran)與邊架艇(Outrigger)的抗浪",
            "versions": {
                "Ver. A 標準探究版": "### 〰️ 波浪殺手\n**目標**：探討船體間距與波長的關係。\n\n#### I. 實驗\n* 在水槽製造波浪，觀察單體船與雙體船的搖晃幅度。",
                "Ver. B 硬派實作版": "### 🏗️ 抗震船體設計\n**目標**：設計抗浪阻尼系統。\n\n#### I. 實作\n* 在模型船加裝彈性邊架，吸收波浪能量。",
                "Ver. C 深度文化版": "### 🛶 獨木舟的平衡桿\n**目標**：南島邊架艇的演化。\n\n#### I. 觀察\n* 達悟族拼板舟為何不需要邊架？(環境差異分析)。"
            }
        }
    ]
}

# ==========================================
# 2. 頁面設定與狀態管理
# ==========================================
st.set_page_config(
    page_title="跨越黑潮 教案實驗室",
    page_icon="🌊",
    layout="wide",
    initial_sidebar_state="expanded"
)

# 初始化 Session State (確保隨機數固定，直到按下按鈕)
if 'random_seed' not in st.session_state:
    st.session_state.random_seed = 0

def randomize():
    # 切換隨機數 (0, 1, 2) 對應三個主題
    st.session_state.random_seed = random.randint(0, 2)

# CSS 優化
st.markdown("""
<style>
    .big-font { font-size:24px !important; font-weight: bold; color: #2E86C1; }
    .stButton>button { border-radius: 20px; border: 2px solid #2E86C1; width: 100%; }
    .metric-card { background-color: #f0f2f6; padding: 15px; border-radius: 10px; }
</style>
""", unsafe_allow_html=True)

# ==========================================
# 3. 側邊欄：控制面板
# ==========================================
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/2922/2922037.png", width=80)
    st.title("⚙️ 課程控制台")
    st.markdown("---")
    
    # 1. 選擇年級
    st.subheader("1. 選擇教學對象")
    grade = st.selectbox(
        "適用年級 (Target Audience)",
        list(full_lesson_db.keys())
    )
    
    # 2. 隨機生成按鈕 (核心功能)
    st.subheader("2. 生成課程主題")
    st.markdown("FP-CRF 內核將從資料庫隨機抽取一個適性教案。")
    if st.button("🎲 隨機運算新主題 (Reroll)"):
        randomize()
        
    # 取得當前隨機主題
    # 這裡確保 index 不會超過列表長度 (雖然我們設定是3個)
    topic_list = full_lesson_db[grade]
    current_index = st.session_state.random_seed % len(topic_list)
    current_data = topic_list[current_index]

    st.success(f"已鎖定：{current_data['topic_name']}")

    # 3. 選擇風格
    st.subheader("3. 選擇教學模式")
    version = st.radio(
        "教案風格 (Style)",
        ["Ver. A 標準探究版", "Ver. B 硬派實作版", "Ver. C 深度文化版"]
    )
    
    st.markdown("---")
    st.caption("Engine: **跨越黑潮 v7.1 (Randomized)**")

# ==========================================
# 4. 主畫面：儀表板與教案
# ==========================================

# 標題區
st.markdown(f"# 🌊 跨越黑潮：{grade.split(' ')[0]}教案")
st.markdown(f"### 🎯 {current_data['topic_name']}")
st.caption(f"模式：{version}")

# 數據儀表板
col1, col2, col3 = st.columns(3)
with col1:
    st.info(f"**📚 課綱重點**\n\n{current_data['課綱重點']}")
with col2:
    st.success(f"**💡 核心概念**\n\n{current_data['核心概念']}")
with col3:
    # 根據版本顯示指標
    if "Ver. A" in version:
        st.metric("科學含量", "⭐⭐⭐⭐")
        st.progress(80)
    elif "Ver. B" in version:
        st.metric("實作強度", "🔥🔥🔥🔥🔥")
        st.progress(95)
    else:
        st.metric("文化深度", "🌏🌏🌏🌏")
        st.progress(85)

st.markdown("---")

# 教案內容區
current_lesson_text = current_data["versions"][version]

tab1, tab2, tab3 = st.tabs(["📋 教案內容", "🛠️ 教學資源", "📊 評量指標"])

with tab1:
    st.subheader(f"📌 {version} 詳細流程")
    st.markdown(current_lesson_text)
    
    st.markdown("---")
    st.download_button(
        label="📥 下載此教案 (.md)",
        data=current_lesson_text,
        file_name=f"Lesson_{grade.split(' ')[0]}_{st.session_state.random_seed}.md",
        mime="text/markdown",
        type="primary"
    )

with tab2:
    st.subheader("🧰 建議器材與準備")
    col_a, col_b = st.columns(2)
    with col_a:
        st.checkbox("🌊 水槽/水桶")
        st.checkbox("💨 電風扇/吹風機")
        st.checkbox("📄 學習單 (已附於詳案)")
    with col_b:
        if "Ver. B" in version:
            st.checkbox("🔧 珍珠板/保麗龍 (耗材)")
            st.checkbox("✂️ 美工刀/熱熔膠")
        elif "Ver. C" in version:
            st.checkbox("🎵 原民歌謠/傳說故事")
            st.checkbox("🌿 自然素材 (林投葉/月桃)")
        else:
            st.checkbox("⚖️ 彈簧秤/砝碼")
            st.checkbox("📐 量角器/直尺")

with tab3:
    st.subheader("✅ 核心素養檢核表")
    if "Ver. A" in version:
        st.markdown("- [ ] 能正確操作實驗器材並記錄數據\n- [ ] 能用科學術語(如力矩、浮力)解釋現象\n- [ ] 能參與小組討論並提出假設")
    elif "Ver. B" in version:
        st.markdown("- [ ] 能在限制條件下完成模型製作\n- [ ] 能分析失敗原因並進行修正(迭代)\n- [ ] 能展現團隊分工與合作")
    else:
        st.markdown("- [ ] 能說出與主題相關的文化故事\n- [ ] 能比較傳統智慧與現代科學的異同\n- [ ] 能展現對多元文化的尊重與欣賞")
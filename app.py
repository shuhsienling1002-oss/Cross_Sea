import streamlit as st
import random
import datetime

# ==========================================
# 1. è·¨è¶Šé»‘æ½®ï¼šæ•™æ¡ˆç”Ÿæˆå¼•æ“æ ¸å¿ƒ (Render Engine)
# ==========================================

def render_full_markdown(grade, topic_data, version_style):
    """
    é€™æ˜¯ä¸€å€‹ã€Œå‹•æ…‹æ¨¡çµ„åŒ–ã€çš„ç”Ÿæˆå‡½æ•¸ã€‚
    å®ƒæœƒæ ¹æ“šè¼¸å…¥çš„åƒæ•¸ï¼Œè‡ªå‹•çµ„åˆæˆä¸€ç¯‡æ•¸åƒå­—çš„å®Œæ•´æ•™æ¡ˆã€‚
    """
    
    # 1. å®šç¾©é¢¨æ ¼åƒæ•¸ (Style Config)
    if "Ver. A" in version_style:
        style_title = "æ¨™æº–æ¢ç©¶ç‰ˆ (Balanced Protocol)"
        role_teacher = "å¼•å°è€…èˆ‡æ¦‚å¿µè§£èªªè€…"
        role_student = "ç§‘å­¸æ¢ç©¶è€…"
        methodology = "POE (é æ¸¬-è§€å¯Ÿ-è§£é‡‹) æ•™å­¸æ³•"
        flow_emphasis = "å¼·èª¿ç§‘å­¸åŸç†çš„æ¨å°èˆ‡å¯¦é©—é©—è­‰çš„åš´è¬¹æ€§ã€‚"
        activity_structure = ["å¼•èµ·å‹•æ©Ÿèˆ‡å‡è¨­", "åŸç†è¬›æˆèˆ‡ç¤ºç¯„", "åˆ†çµ„å¯¦é©—èˆ‡è§€å¯Ÿ", "æ•¸æ“šåˆ†æèˆ‡è¨è«–"]
    elif "Ver. B" in version_style:
        style_title = "ç¡¬æ´¾å¯¦ä½œç‰ˆ (Maker Protocol)"
        role_teacher = "å·¥ç¨‹ç¸½ç›£ (Director)"
        role_student = "çµæ§‹å·¥ç¨‹å¸« (Engineer)"
        methodology = "EDP (å·¥ç¨‹è¨­è¨ˆæµç¨‹) - è©¦éŒ¯æ³•"
        flow_emphasis = "å¼·èª¿ã€å¤±æ•—-åˆ†æ-ä¿®æ­£ã€çš„è¿­ä»£éç¨‹ï¼Œé¼“å‹µåè„†å¼±ç²¾ç¥ã€‚"
        activity_structure = ["ä»»å‹™ç™¼å¸ƒèˆ‡é™åˆ¶", "ç¬¬ä¸€ä»£åŸå‹è¨­è¨ˆ (Crash Test)", "å¤±æ•—åˆ†æèˆ‡ç‰©ç†æ•‘æ´", "ç¬¬äºŒä»£å„ªåŒ–èˆ‡æ±ºæˆ°"]
    else: # Ver. C
        style_title = "æ·±åº¦æ–‡åŒ–ç‰ˆ (Cultural Immersion)"
        role_teacher = "æ–‡åŒ–è½‰è­¯è€…"
        role_student = "éƒ¨è½è¦‹ç¿’ç”Ÿ"
        methodology = "æƒ…å¢ƒæ²‰æµ¸èˆ‡æ–‡åŒ–å›æ‡‰æ•™å­¸"
        flow_emphasis = "å¼·èª¿åŸä½æ°‘æ—ä¸–ç•Œè§€èˆ‡è¥¿æ–¹ç§‘å­¸çš„å°è©±ã€‚"
        activity_structure = ["æ–‡åŒ–æ²‰æµ¸èˆ‡å‚³èªª", "å‚³çµ±æ™ºæ…§çš„ç§‘å­¸è§£ç¢¼", "å„€å¼æ„Ÿå¯¦ä½œé«”é©—", "åæ€èˆ‡åƒ¹å€¼é€£çµ"]

    # 2. ç²å–ä¸»é¡Œç‰¹å®šè³‡æ–™
    t_name = topic_data["name"]
    t_concept = topic_data["concept"]
    t_competency = topic_data["competency"]
    t_context = topic_data["context"]
    t_steps = topic_data["steps"][version_style[:6]] # æŠ“å–å°æ‡‰ç‰ˆæœ¬çš„æ­¥é©Ÿç´°ç¯€

    # 3. çµ„åˆ Markdown æ–‡æœ¬
    markdown_content = f"""
# ã€è·¨è¶Šé»‘æ½®ã€‘æ­£å¼æ•™æ¡ˆè¨­è¨ˆï¼š{t_name}

| é …ç›® | å…§å®¹èªªæ˜ |
| :--- | :--- |
| **å–®å…ƒåç¨±** | {t_name} â€”â€” {style_title} |
| **è¨­è¨ˆæ ¸å¿ƒ** | **è·¨è¶Šé»‘æ½® (Crossing the Kuroshio)** |
| **é©ç”¨å°è±¡** | {grade} |
| **æ•™å­¸æ™‚é–“** | 90 åˆ†é˜ (å…©ç¯€èª²é€£æ’) |
| **æ•™æä¾†æº** | è‡ªç·¨æ•™æ (çµåˆåŸä½æ°‘æ—èªæ–‡èª²ç¶±èˆ‡è‡ªç„¶é ˜ç¶±) |
| **æ•™å­¸æ¨¡å¼** | {methodology} |

---

## å£¹ã€ è¨­è¨ˆç†å¿µèˆ‡æ ¸å¿ƒç´ é¤Š

### ä¸€ã€ è¨­è¨ˆç†å¿µ
æœ¬èª²ç¨‹ä»¥ã€Œå—å³¶èªæ—è·¨è¶Šé»‘æ½®ã€ç‚ºæ ¸å¿ƒæƒ…å¢ƒï¼Œçµåˆ **{t_concept}** çš„ç§‘å­¸æ¦‚å¿µã€‚
{flow_emphasis}
å­¸ç”Ÿå°‡æ‰®æ¼” **{role_student}** çš„è§’è‰²ï¼Œåœ¨ **{role_teacher}** çš„å¸¶é ˜ä¸‹ï¼Œé€éå¯¦ä½œç†è§£å‚³çµ±å·¥è—èƒŒå¾Œçš„ç”Ÿå­˜æ™ºæ…§ã€‚

### äºŒã€ æ ¸å¿ƒç´ é¤Š (Key Competencies)
* **ä¸»è¦ç´ é¤Š**ï¼š{t_competency}
* **è·¨ç§‘é€£çµ**ï¼š
    * **[åŸ-J-A1]**ï¼šå…·å‚™ç©æ¥µä¸»å‹•å­¸ç¿’æ—èªçš„èƒ½åŠ›èˆ‡èˆˆè¶£ï¼Œå±•ç¾åŸä½æ°‘æ—æ–‡åŒ–ä¸»é«”æ€§ã€‚
    * **[Sa-IV-2]**ï¼šèƒ½é‹ç”¨ç§‘å­¸åŸç†èˆ‡æ–¹æ³•ï¼Œè§£æ±ºæ—¥å¸¸ç”Ÿæ´»çš„å•é¡Œã€‚

### ä¸‰ã€ å­¸ç¿’ç›®æ¨™ (Learning Objectives)
1.  **[èªçŸ¥]** èƒ½è§£é‡‹ {t_concept} åœ¨é»‘æ½®èˆªè¡Œä¸­çš„æ‡‰ç”¨åŸç†ã€‚
2.  **[æŠ€èƒ½]** èƒ½{t_steps['skill_goal']}ã€‚
3.  **[æƒ…æ„]** èƒ½{t_steps['affective_goal']}ã€‚

---

## è²³ã€ æ•™å­¸æ´»å‹•æµç¨‹ (Detailed Procedure)

### ç¬¬ä¸€ç¯€èª²ï¼š{activity_structure[0]} & {activity_structure[1]} (45 mins)

#### 1. {activity_structure[0]} (15 mins)
* **æƒ…å¢ƒå°å…¥**ï¼š
    * {t_context}
    * æ•™å¸«æå•ï¼šã€Œ{t_steps['hook_question']}ã€
* **å­¸ç”Ÿæ´»å‹•**ï¼š
    * åˆ†çµ„è¨è«–ä¸¦æå‡ºåˆæ­¥æƒ³æ³•ã€‚
    * {t_steps['step1_student']}

#### 2. {activity_structure[1]} (30 mins)
* **æ ¸å¿ƒæ¢ç©¶**ï¼š
    * æ•™å¸«å¼•å°ï¼š{t_steps['teacher_guide']}
    * é—œéµæ¦‚å¿µè§£æï¼š
        > **{t_concept}**
        > 
        > {t_steps['concept_detail']}
* **å­¸ç”Ÿæ´»å‹•**ï¼š
    * å­¸ç”Ÿé€²è¡Œ{t_steps['step2_student']}ã€‚
    * å®Œæˆå­¸ç¿’å–® Part 1ï¼šé æ¸¬èˆ‡å‡è¨­ã€‚

---

### ç¬¬äºŒç¯€èª²ï¼š{activity_structure[2]} & {activity_structure[3]} (45 mins)

#### 3. {activity_structure[2]} (25 mins)
* **å¯¦ä½œæŒ‘æˆ°**ï¼š
    * ä»»å‹™ç›®æ¨™ï¼š{t_steps['task_goal']}
    * **æ“ä½œæ­¥é©Ÿ**ï¼š
        1. é ˜å–ææ–™ï¼š{t_steps['materials']}
        2. é€²è¡Œè£½ä½œèˆ‡çµ„è£ã€‚
        3. **æ¸¬è©¦ç’°ç¯€**ï¼š{t_steps['test_method']}
* **è§€å¯Ÿé‡é»**ï¼š
    * {t_steps['observation_focus']}

#### 4. {activity_structure[3]} (20 mins)
* **ç¶œåˆè¨è«–**ï¼š
    * å„çµ„å±•ç¤ºæˆæœèˆ‡æ•¸æ“šã€‚
    * æ•™å¸«å¼•å°åæ€ï¼š{t_steps['reflection_guide']}
* **æ–‡åŒ–ç¸½çµ**ï¼š
    * åŸä½æ°‘æ—çš„ç§‘æŠ€æ˜¯ç‚ºäº†é©æ‡‰ç’°å¢ƒè€Œæ¼”åŒ–çš„æœ€ä½³è§£ã€‚
    * çœŸæ­£çš„æ™ºæ…§ä¸åªåœ¨èª²æœ¬è£¡ï¼Œä¹Ÿåœ¨éƒ¨è½çš„å‚³çµ±å·¥è—ä¸­ã€‚

---

## åƒã€ è©•é‡è¦æº– (Assessment Rubric)

| å‘åº¦ | C (å¾…åŠ å¼·) | B (åŸºç¤) | A (ç²¾ç†Ÿ) |
| :--- | :--- | :--- | :--- |
| **ç§‘å­¸çŸ¥è­˜** | ç„¡æ³•è§£é‡‹{t_concept}åŸç†ã€‚ | èƒ½å¤§è‡´èªªæ˜åŸç†ï¼Œä½†æœ‰éƒ¨åˆ†è¿·æ€ã€‚ | èƒ½ç²¾ç¢ºé‹ç”¨{t_concept}è§£é‡‹å¯¦é©—ç¾è±¡ã€‚ |
| **å¯¦ä½œè¡¨ç¾** | åƒ…å®Œæˆéƒ¨åˆ†æ¨¡å‹ï¼Œæœªé€²è¡Œæ¸¬è©¦ã€‚ | å®Œæˆæ¨¡å‹ä¸¦é€²è¡Œæ¸¬è©¦ï¼Œæœ‰ç´€éŒ„æ•¸æ“šã€‚ | æ¨¡å‹ä½œå·¥ç²¾ç´°ï¼Œèƒ½æ ¹æ“šæ¸¬è©¦çµæœé€²è¡Œå„ªåŒ–(è¿­ä»£)ã€‚ |
| **æ–‡åŒ–ç†è§£** | èªç‚ºå‚³çµ±å·¥è—åªæ˜¯è£é£¾ã€‚ | çŸ¥é“é€™æ˜¯åŸä½æ°‘æ—çš„è¨­è¨ˆã€‚ | èƒ½æ·±åˆ»é«”èªå‚³çµ±è¨­è¨ˆèƒŒå¾Œçš„ç’°å¢ƒé©æ‡‰æ™ºæ…§ã€‚ |

---

## è‚†ã€ æ•™å­¸è³‡æºèˆ‡æº–å‚™
* **å™¨ææº–å‚™**ï¼š{t_steps['materials']}
* **ç©ºé–“éœ€æ±‚**ï¼š{t_steps['space_need']}
* **æ•¸ä½è³‡æº**ï¼šé»‘æ½®ç´€éŒ„ç‰‡ã€å—å³¶é·å¾™åœ°åœ–ã€‚

*æœ¬æ–‡ä»¶ç”±ã€è·¨è¶Šé»‘æ½®ã€‘æ•™æ¡ˆå¼•æ“æ–¼ {datetime.date.today()} è‡ªå‹•ç”Ÿæˆ*
"""
    return markdown_content

# ==========================================
# 2. æ•™æ¡ˆè³‡æ–™åº« (Raw Data)
# ==========================================
# é€™è£¡åªå­˜ã€Œé—œéµå·®ç•°ã€ï¼Œè®“ä¸Šé¢çš„å¼•æ“å»çµ„è£
# é€™æ¨£æˆ‘å€‘å¯ä»¥ç”¨å¾ˆå°‘çš„ä»£ç¢¼ï¼Œç”Ÿæˆç„¡é™å¤šçš„ã€Œè©³æ¡ˆã€

topics_db = {
    "åœ‹ä¸­ä¸ƒå¹´ç´š (ç”Ÿç‰©/çµæ§‹)": [
        {
            "name": "æµ·ä¸Šçš„ä»¿ç”Ÿå­¸ï¼šèŸ¹çˆªèˆ‡å¸†",
            "concept": "ç”Ÿç‰©çµæ§‹èˆ‡åŠŸèƒ½ (Structure and Function)",
            "competency": "[Im-IV-2] è§€å¯Ÿç”Ÿç‰©çš„å½¢æ…‹èˆ‡æ§‹é€ ",
            "context": "è§€å¯Ÿæ‹›æ½®èŸ¹çš„å¤§è¯èˆ‡å—å³¶èŸ¹çˆªå¸†çš„å½¢ç‹€ç›¸ä¼¼æ€§ï¼Œæ¢è¨ç”Ÿç‰©æ¼”åŒ–èˆ‡äººé¡ç§‘æŠ€çš„é—œä¿‚ã€‚",
            "steps": {
                "Ver. A": {
                    "skill_goal": "æ“ä½œé¢¨æ´å¯¦é©—æ¯”è¼ƒä¸åŒå½¢ç‹€çš„æŠ—é¢¨æ€§",
                    "affective_goal": "æ¬£è³ç”Ÿç‰©çµæ§‹çš„æ¼”åŒ–æ™ºæ…§",
                    "hook_question": "ç‚ºä»€éº¼èƒèŸ¹çš„è¯æ˜¯å¼§å½¢çš„ï¼Ÿç‚ºä»€éº¼å—å³¶ç¥–å…ˆçš„å¸†ä¹Ÿæ˜¯å¼§å½¢çš„ï¼Ÿ",
                    "step1_student": "è§€å¯ŸèƒèŸ¹æ¨™æœ¬èˆ‡èŸ¹çˆªå¸†åœ–ç‰‡ï¼Œæ‰¾å‡ºå¹¾ä½•å…±åŒé»ã€‚",
                    "teacher_guide": "è¬›è§£ä»¿ç”Ÿå­¸(Biomimicry)æ¦‚å¿µï¼Œèªªæ˜å¼§å½¢çµæ§‹å¦‚ä½•åˆ†æ•£å—åŠ›ã€‚",
                    "concept_detail": "æµç·šå‹èˆ‡å¼§é¢èƒ½å¼•å°æ°£æµï¼Œæ¸›å°‘ç›´æ¥è¡æ“Šï¼Œé€™æ˜¯ã€å¸åŠ›ã€è€Œéã€æŠ—åŠ›ã€çš„æ™ºæ…§ã€‚",
                    "step2_student": "ç¹ªè£½å—åŠ›é æ¸¬åœ–ã€‚",
                    "task_goal": "é©—è­‰èŸ¹çˆªå½¢è‘‰ç‰‡åœ¨å¼·é¢¨ä¸‹çš„ç©©å®šåº¦ã€‚",
                    "materials": "é›»é¢¨æ‰‡ã€åšç´™æ¿(è£åˆ‡æˆæ–¹å½¢èˆ‡èŸ¹çˆªå½¢)ã€ç«¹ç±¤ã€åº•åº§ã€‚",
                    "test_method": "é–‹å•Ÿé¢¨æ‰‡ï¼Œè§€å¯Ÿå…©ç¨®è‘‰ç‰‡åº•åº§çš„æ™ƒå‹•ç¨‹åº¦ã€‚",
                    "observation_focus": "å“ªä¸€ç¨®å½¢ç‹€èƒ½è®“é¢¨é †åˆ©é€šéè€Œä¸åŠ‡çƒˆéœ‡å‹•ï¼Ÿ",
                    "reflection_guide": "å¦‚æœè¦åœ¨é¢±é¢¨å¤©é€ æˆ¿å­ï¼Œä½ æœƒæ¨¡ä»¿å“ªç¨®ç”Ÿç‰©çš„çµæ§‹ï¼Ÿ",
                    "space_need": "ä¸€èˆ¬æ•™å®¤ï¼Œéœ€é›»æºæ’åº§ã€‚"
                },
                "Ver. B": {
                    "skill_goal": "åˆ©ç”¨è©¦èª¤æ³•æ‰¾å‡ºæœ€ä½³æŠ—é¢¨çµæ§‹",
                    "affective_goal": "å»ºç«‹å¾å¤±æ•—ä¸­å­¸ç¿’çš„å·¥ç¨‹å¸«ç²¾ç¥",
                    "hook_question": "ä½ èƒ½ç”¨ç´™åšå‡ºä¸€é¢å¹ä¸å€’çš„ç‰†å—ï¼Ÿ",
                    "step1_student": "å¿«é€Ÿè£½ä½œç¬¬ä¸€ä»£ç´™å¸†ï¼ˆé€šå¸¸æ˜¯æ–¹å½¢ï¼‰ã€‚",
                    "teacher_guide": "å¼•å°å­¸ç”Ÿé€²è¡Œç ´å£æ€§æ¸¬è©¦ï¼Œä¸¦å¼•å…¥ã€çµæ§‹å„ªåŒ–ã€æ¦‚å¿µã€‚",
                    "concept_detail": "çµæ§‹å¼·åº¦ä¸åƒ…å–æ±ºæ–¼ææ–™ï¼Œæ›´å–æ±ºæ–¼å½¢ç‹€ï¼ˆå¹¾ä½•å‰›æ€§ï¼‰ã€‚",
                    "step2_student": "é€²è¡Œç¬¬ä¸€è¼ªæ®˜é…·æ¸¬è©¦ï¼ˆå…¨å€’ï¼‰ã€‚",
                    "task_goal": "åœ¨å¼·é¢¨ä¸‹ç”Ÿå­˜ã€‚",
                    "materials": "å ±ç´™ã€å¸ç®¡ã€è† å¸¶ã€å¼·åŠ›å·¥æ¥­æ‰‡ã€‚",
                    "test_method": "å¼·é¢¨ç›´å¹ï¼Œè¨ˆç®—å­˜æ´»ç§’æ•¸ã€‚",
                    "observation_focus": "çµæ§‹å´©å£çš„èµ·é»åœ¨å“ªè£¡ï¼Ÿå¦‚ä½•åŠ å¼·ï¼Ÿ",
                    "reflection_guide": "ç‚ºä»€éº¼æ¨¡ä»¿ç”Ÿç‰©(èŸ¹çˆª)çš„çµæ§‹æœ€å¾Œæ´»ä¸‹ä¾†äº†ï¼Ÿ",
                    "space_need": "èµ°å»Šæˆ–ç©ºæ› è™•ï¼Œæœƒæœ‰ç´™å±‘é£›æ•£ã€‚"
                },
                "Ver. C": {
                    "skill_goal": "é€éæ‰‹ä½œç·¨ç¹”é«”é©—å‚³çµ±å·¥è—",
                    "affective_goal": "å°Šé‡ä¸¦å‚³æ‰¿éƒ¨è½çš„è‡ªç„¶çŸ¥è­˜",
                    "hook_question": "è€äººå®¶èªªå¸†æœ‰ã€çœ¼ç›ã€ï¼Œé‚£æ˜¯ç”šéº¼æ„æ€ï¼Ÿ",
                    "step1_student": "è†è½é—œæ–¼èŸ¹çˆªå¸†çš„éƒ¨è½å‚³èªªã€‚",
                    "teacher_guide": "è¬›è¿°é˜¿ç¾æ—å°æµ·æ´‹ç”Ÿç‰©çš„è§€å¯Ÿèˆ‡å‘½åå“²å­¸ã€‚",
                    "concept_detail": "è¬ç‰©æœ‰éˆèˆ‡ç”Ÿæ…‹å¹³è¡¡çš„è§€é»ã€‚",
                    "step2_student": "å˜—è©¦ä½¿ç”¨æ—æŠ•è‘‰æˆ–æœˆæ¡ƒè‘‰é€²è¡Œç°¡æ˜“ç·¨ç¹”ã€‚",
                    "task_goal": "å®Œæˆå…·æœ‰æ–‡åŒ–æ„ç¾©çš„å°æ¨¡å‹ã€‚",
                    "materials": "è‡ªç„¶ç´ æ(è‘‰ç‰‡)ã€éº»ç¹©ã€ç«¹ç‰‡ã€‚",
                    "test_method": "é€²è¡Œä¸‹æ°´ç¥ˆç¦å„€å¼ï¼ˆæ¨¡æ“¬ï¼‰ã€‚",
                    "observation_focus": "æ„Ÿå—è‡ªç„¶æè³ªçš„éŸŒæ€§èˆ‡æº«åº¦ã€‚",
                    "reflection_guide": "æˆ‘å€‘ç¾ä»£äººæ˜¯å¦å¿˜è¨˜äº†å¦‚ä½•èˆ‡è‡ªç„¶å°è©±ï¼Ÿ",
                    "space_need": "æ•™å®¤ï¼Œéœ€æº–å‚™ç·¨ç¹”å·¥å…·ã€‚"
                }
            }
        },
        {
            "name": "ç¨®å­çš„æ—…è¡Œï¼šé»‘æ½®æ¼‚æµè¨˜",
            "concept": "æµ®åŠ›èˆ‡å‚³æ’­ (Buoyancy and Dispersal)",
            "competency": "[Ib-IV-1] ç”Ÿç‰©çš„ç”Ÿæ®–èˆ‡ç¹è¡",
            "context": "æ£‹ç›¤è…³èˆ‡æ¤°å­å¦‚ä½•åˆ©ç”¨æ§‹é€ éš¨é»‘æ½®æ¼‚æµåˆ°å°ç£ï¼Ÿ",
            "steps": {
                "Ver. A": {
                    "skill_goal": "è§£å‰–æ¤ç‰©æœå¯¦è§€å¯Ÿæ§‹é€ ", "affective_goal": "é«”æœƒç”Ÿå‘½å‚³æ’­çš„éŸŒæ€§",
                    "hook_question": "ä¸æœƒæ¸¸æ³³çš„æ¤°å­ï¼Œæ€éº¼å¾è²å¾‹è³“ä¾†åˆ°å°ç£ï¼Ÿ",
                    "step1_student": "è§€å¯Ÿä¸¦è§£å‰–æ¤°å­æˆ–æ£‹ç›¤è…³æœå¯¦ã€‚",
                    "teacher_guide": "è¬›è§£ä¸­ç©ºæ§‹é€ å¢åŠ æ’æ°´é«”ç©ï¼Œé€²è€Œå¢å¤§æµ®åŠ›çš„åŸç†ã€‚",
                    "concept_detail": "B = V_displaced Ã— D_fluidã€‚ä¸­ç©º=å¤§é«”ç©+è¼•é‡é‡ã€‚",
                    "step2_student": "æ¸¬é‡ä¸åŒæœå¯¦çš„å¯†åº¦ã€‚",
                    "task_goal": "æ¯”è¼ƒä¸åŒæ¤ç‰©çš„æ¼‚æµ®åŠ›ã€‚",
                    "materials": "æ°´æ§½ã€æ¤°å­ã€å„é¡æœå¯¦ã€å½ˆç°§ç§¤ã€‚",
                    "test_method": "å°‡æœå¯¦å£“å…¥æ°´ä¸­æ”¾é–‹ï¼Œè§€å¯Ÿæµ®èµ·é€Ÿåº¦ã€‚",
                    "observation_focus": "å¤–çš®é˜²æ°´å±¤èˆ‡å…§éƒ¨çº–ç¶­å±¤çš„åŠŸèƒ½ã€‚",
                    "reflection_guide": "å—å³¶ç¥–å…ˆçš„èˆ¹æ˜¯å¦ä¹Ÿæ¨¡ä»¿äº†é€™ç¨®ä¸­ç©ºæ§‹é€ ï¼Ÿ(ç«¹ç­)",
                    "space_need": "ç”Ÿç‰©å¯¦é©—å®¤ï¼Œéœ€æ°´æ§½ã€‚"
                },
                "Ver. B": {
                    "skill_goal": "è¨­è¨ˆé˜²æ°´æ¼‚æµ®åŒ…è£¹", "affective_goal": "åŸ¹é¤Šè§£æ±ºå•é¡Œçš„èƒ½åŠ›",
                    "hook_question": "å¦‚ä½•è®“ä¸€é¡†æ–¹ç³–åœ¨æ°´è£¡æ¼‚æµ10åˆ†é˜ä¸æº¶åŒ–ï¼Ÿ",
                    "step1_student": "è¨­è¨ˆä¿è­·æ–¹ç³–çš„è¼‰å…·ã€‚",
                    "teacher_guide": "æç¤ºåƒè€ƒæ¤°å­çš„å¤šå±¤ä¿è­·çµæ§‹ï¼ˆçº–ç¶­+ç¡¬æ®¼ï¼‰ã€‚",
                    "concept_detail": "å·¥ç¨‹é˜²è­·è¨­è¨ˆï¼šé˜²æ°´ã€é˜²æ’ã€æŠ—è…è•ã€‚",
                    "step2_student": "è£½ä½œåŸå‹ä¸¦æ”¾å…¥æ°´æ¡¶ã€‚",
                    "task_goal": "ä¿è­·è²¨ç‰©(æ–¹ç³–)å®Œæ•´ç„¡ç¼ºã€‚",
                    "materials": "æ–¹ç³–ã€æ°£æ³¡ç´™ã€å¸ç®¡ã€è† å¸¶ã€æ°´æ¡¶ã€‚",
                    "test_method": "åŠ‡çƒˆæ–æ™ƒæ°´æ¡¶æ¨¡æ“¬é»‘æ½®æµªæ³ã€‚",
                    "observation_focus": "æ°´æ˜¯å¦‚ä½•æ»²é€é€²å»çš„ï¼Ÿ",
                    "reflection_guide": "é€™è·Ÿé€ èˆ¹çš„ã€æ°´å¯†éš”è‰™ã€æœ‰ä»€éº¼ç•°æ›²åŒå·¥ä¹‹å¦™ï¼Ÿ",
                    "space_need": "æ•™å®¤ï¼Œéœ€ä¸æ€•æ¿•çš„åœ°æ¿ã€‚"
                },
                "Ver. C": {
                    "skill_goal": "ç¹ªè£½å—å³¶æ¤ç‰©å‚³æ’­åœ°åœ–", "affective_goal": "èªè­˜æ°‘æ—æ¤ç‰©å­¸",
                    "hook_question": "ç¥–å…ˆçš„è¡Œæç®±è£¡å¸¶äº†ä»€éº¼ç¨®å­ï¼Ÿ",
                    "step1_student": "èªè­˜éºµåŒ…æ¨¹ã€æ§‹æ¨¹ç­‰å—å³¶æŒ‡æ¨™æ¤ç‰©ã€‚",
                    "teacher_guide": "è¬›è¿°å¸¶è‘—å®¶é„‰æ¤ç‰©å»æ—…è¡Œçš„ç§»æ°‘æ•…äº‹ã€‚",
                    "concept_detail": "æ°‘æ—æ¤ç‰©å­¸(Ethnobotany)ï¼šæ¤ç‰©èˆ‡æ–‡åŒ–çš„å…±ç”Ÿã€‚",
                    "step2_student": "ç¹ªè£½æ¤ç‰©éš¨é»‘æ½®å‚³æ’­çš„è·¯å¾‘åœ–ã€‚",
                    "task_goal": "é‡å»ºå—å³¶é·å¾™çš„ç¶ è‰²è·¯å¾‘ã€‚",
                    "materials": "ä¸–ç•Œåœ°åœ–ã€æ¤ç‰©åœ–å¡ã€è‰²ç­†ã€‚",
                    "test_method": "å°çµ„åˆ†äº«åœ°åœ–æ•…äº‹ã€‚",
                    "observation_focus": "æ¤ç‰©åˆ†ä½ˆèˆ‡èªè¨€åˆ†ä½ˆçš„é‡ç–Šæ€§ã€‚",
                    "reflection_guide": "å¦‚æœä½ è¦ç§»æ°‘ç«æ˜Ÿï¼Œä½ æœƒå¸¶ä»€éº¼ç¨®å­ï¼Ÿ",
                    "space_need": "ä¸€èˆ¬æ•™å®¤ã€‚"
                }
            }
        },
        # ... å¯ä»¥åœ¨æ­¤ç¹¼çºŒæ“´å……æ›´å¤šä¸ƒå¹´ç´šä¸»é¡Œ
    ],

    "åœ‹ä¸­å…«å¹´ç´š (ç†åŒ–/æµ®åŠ›)": [
        {
            "name": "ç«¹ç­çš„ç§˜å¯†ï¼šå¯†åº¦èˆ‡æµ®åŠ›",
            "concept": "å¯†åº¦èˆ‡é˜¿åŸºç±³å¾·åŸç† (Density & Archimedes' Principle)",
            "competency": "[PEb-IV-1] å¯†åº¦èˆ‡æµ®åŠ›",
            "context": "é˜¿ç¾æ—ç«¹ç­(Fayan)åˆ©ç”¨å·¨ç«¹çš„ä¸­ç©ºçµæ§‹ï¼Œå‰µé€ é©šäººçš„è¼‰é‡é‡ã€‚",
            "steps": {
                "Ver. A": {
                    "skill_goal": "è¨ˆç®—ç‰©é«”çš„å¯†åº¦èˆ‡æµ®åŠ›", "affective_goal": "è®šå˜†å‚³çµ±ææ–™çš„ç§‘å­¸æ€§",
                    "hook_question": "åŒæ¨£å¤§å°çš„æœ¨é ­å’Œç«¹å­ï¼Œèª°è¼‰å¾—é‡ï¼Ÿ",
                    "step1_student": "æ¸¬é‡å¯¦å¿ƒæœ¨èˆ‡ç«¹ç®¡çš„è³ªé‡èˆ‡é«”ç©ã€‚",
                    "teacher_guide": "æ¨å° D=M/Vï¼Œèªªæ˜ç«¹å­å› ç‚ºä¸­ç©ºï¼Œæ•´é«”å¯†åº¦æ¥µä½ã€‚",
                    "concept_detail": "å¹³å‡å¯†åº¦ < æ¶²é«”å¯†åº¦ = æµ®é«”ã€‚ç«¹å­çš„ã€å¹³å‡å¯†åº¦ã€é å°æ–¼æœ¨é ­ã€‚",
                    "step2_student": "è¨ˆç®—å…©è€…çš„ç†è«–æœ€å¤§è¼‰é‡ã€‚",
                    "task_goal": "é©—è­‰ç«¹ç­çš„é«˜è¼‰é‡æ•ˆç‡ã€‚",
                    "materials": "ç«¹ç®¡ã€æœ¨æ¢ã€é›»å­ç§¤ã€é‡ç­’ã€æ°´ã€‚",
                    "test_method": "åœ¨æ°´æ§½ä¸­ä¸æ–·åŠ æ›ç ç¢¼ç›´åˆ°æ²‰æ²’ã€‚",
                    "observation_focus": "åƒæ°´ç·šçš„è®ŠåŒ–ã€‚",
                    "reflection_guide": "ç‚ºä»€éº¼é»‘æ½®ä¸Šçš„èˆ¹å¤šç”¨ç«¹ç­è€Œéç¨æœ¨èˆŸï¼Ÿ(æŠ—æµªæ€§/ä¸æ²‰æ€§)",
                    "space_need": "ç†åŒ–å¯¦é©—å®¤ã€‚"
                },
                "Ver. B": {
                    "skill_goal": "æœ€ä½³åŒ–è¼‰å…·è¨­è¨ˆ", "affective_goal": "è¿½æ±‚æ¥µè‡´æ•ˆèƒ½",
                    "hook_question": "ç”¨ä¸€å¼µA4é‹ç®”ç´™ï¼Œèª°èƒ½è¼‰æœ€å¤šç¡¬å¹£ï¼Ÿ",
                    "step1_student": "æŠ˜ç–Šé‹ç®”ç´™èˆ¹ã€‚",
                    "teacher_guide": "æç¤ºï¼šå¢åŠ æ’æ°´é«”ç©æ˜¯é—œéµï¼Œä½†è¦æ³¨æ„èˆ¹å£é«˜åº¦ã€‚",
                    "concept_detail": "æœ€å¤§æ’æ°´é«”ç© = æœ€å¤§æµ®åŠ›ã€‚",
                    "step2_student": "é€²è¡Œè¼‰é‡ç«¶è³½ã€‚",
                    "task_goal": "æ‰“ç ´ç­ç´šè¼‰é‡ç´€éŒ„ã€‚",
                    "materials": "A4é‹ç®”ç´™ã€ä¸€å…ƒç¡¬å¹£(ç´„100æš/çµ„)ã€æ°´ç›†ã€‚",
                    "test_method": "ä¸€æšä¸€æšè¼•æ”¾ï¼Œç›´åˆ°é€²æ°´æ²‰æ²’ã€‚",
                    "observation_focus": "èˆ¹å½¢è®Šå½¢å°è‡´çš„é€²æ°´ç¬é–“ã€‚",
                    "reflection_guide": "ç«¹ç­çš„ã€å¤šç¯€çµæ§‹ã€å¦‚ä½•é¿å…é€™é¡ç½é›£ï¼Ÿ(æ°´å¯†æ€§)",
                    "space_need": "ä¸€èˆ¬æ•™å®¤ã€‚"
                },
                "Ver. C": {
                    "skill_goal": "èªè­˜å‚³çµ±ç«¹æè™•ç†å·¥æ³•", "affective_goal": "å‚³æ‰¿å·¥è—ç²¾ç¥",
                    "hook_question": "ç«¹å­ç›´æ¥ç ä¸‹ä¾†å°±èƒ½é€ èˆ¹å—ï¼Ÿ",
                    "step1_student": "è§€çœ‹ç«¹ç­è£½ä½œç´€éŒ„ç‰‡(æ®ºé’ã€çƒ¤å½)ã€‚",
                    "teacher_guide": "è§£é‡‹ã€æ®ºé’ã€å»é™¤æ°´åˆ†ç³–åˆ†é˜²èŸ²ï¼Œã€çƒ¤å½ã€å¢åŠ èˆ¹é ­ç¿¹èµ·çš„æµé«”åŠ›å­¸ã€‚",
                    "concept_detail": "ææ–™ç§‘å­¸è™•ç†ï¼šé˜²è…èˆ‡ç†±å¡‘æ€§ã€‚",
                    "step2_student": "æ¨¡æ“¬ç«¹æé¸æ–™éç¨‹ã€‚",
                    "task_goal": "é¸å‡ºé©åˆé€ èˆ¹çš„ã€ç«¹å­ã€(æ¨¡æ“¬)ã€‚",
                    "materials": "ä¸åŒç²—ç´°/å¹´ä»½çš„ç«¹ææ¨£æœ¬(æˆ–åœ–ç‰‡)ã€‚",
                    "test_method": "å°çµ„è¨è«–é¸æ–™ç†ç”±ã€‚",
                    "observation_focus": "ç«¹ç¯€é–“è·ã€ç«¹å£åšåº¦ã€‚",
                    "reflection_guide": "å·¥è—æ˜¯ç§‘å­¸èˆ‡ç¶“é©—çš„ç´¯ç©ã€‚",
                    "space_need": "ä¸€èˆ¬æ•™å®¤ã€‚"
                }
            }
        },
        # ... å…«å¹´ç´šå…¶ä»–ä¸»é¡Œ
    ],

    "åœ‹ä¸­ä¹å¹´ç´š (ç†åŒ–/åŠ›çŸ©)": [
        {
            "name": "èª°èƒ½æ´»è‘—æ¸¡éé»‘æ½®ï¼Ÿ",
            "concept": "åŠ›çŸ©èˆ‡å‘é‡åˆ†è§£ (Torque & Vector Decomposition)",
            "competency": "[Sa-IV-2] åŠ›èˆ‡é‹å‹•çš„è§£é‡‹",
            "context": "å—å³¶èŸ¹çˆªå¸†åˆ©ç”¨ä½é‡å¿ƒè¨­è¨ˆï¼Œå…‹æœé»‘æ½®å¼·å‹å´é¢¨é€ æˆçš„ç¿»èˆ¹åŠ›çŸ©ã€‚",
            "steps": {
                "Ver. A": {
                    "skill_goal": "ç¹ªè£½å¸†èˆ¹å—åŠ›åˆ†æåœ–", "affective_goal": "é«”èªç§‘å­¸èˆ‡æ–‡åŒ–çš„é€£çµ",
                    "hook_question": "å¦‚æœä½ ç©¿è¶Šå›å¤ä»£ï¼Œä½ æœƒé¸æ–¹å½¢å¸†é‚„æ˜¯å€’ä¸‰è§’å¸†ä¾†æ¸¡æµ·ï¼Ÿ",
                    "step1_student": "ç¹ªè£½é¢¨åŠ›å‘é‡åˆ†è§£åœ–ã€‚",
                    "teacher_guide": "è¬›è§£åŠ›çŸ©å¹³è¡¡ï¼šæŠ—ç¿»åŠ›çŸ©å¿…é ˆå¤§æ–¼ç¿»èˆ¹åŠ›çŸ©ã€‚",
                    "concept_detail": "ç¿»èˆ¹åŠ›çŸ© = å´å‘åˆ†åŠ› Ã— å—åŠ›ä¸­å¿ƒé«˜åº¦(åŠ›è‡‚)ã€‚",
                    "step2_student": "æ¯”è¼ƒæ–¹å¸†èˆ‡èŸ¹çˆªå¸†çš„åŠ›è‡‚é•·åº¦ã€‚",
                    "task_goal": "è­‰æ˜èŸ¹çˆªå¸†è¼ƒç©©å®šã€‚",
                    "materials": "ä¿éº—é¾èˆ¹æ¨¡å‹ã€å…©ç¨®å½¢ç‹€ç´™å¸†ã€é¢¨æ‰‡ã€æ°´æ§½ã€‚",
                    "test_method": "å´é¢¨å¹æ‹‚ï¼Œè§€å¯Ÿå‚¾æ–œè§’ã€‚",
                    "observation_focus": "å—é¢¨ä¸­å¿ƒçš„è¦–è¦ºä½ç½®ã€‚",
                    "reflection_guide": "ç‚ºä»€éº¼ç¾ä»£å¸†èˆ¹(é‡å¿ƒé«˜)éœ€è¦å¾ˆé‡çš„é¾éª¨ï¼Ÿå¤ä»£ç«¹ç­æ²’æœ‰é¾éª¨æ€éº¼è¾¦ï¼Ÿ",
                    "space_need": "ç†åŒ–å¯¦é©—å®¤/èµ°å»Šã€‚"
                },
                "Ver. B": {
                    "skill_goal": "é€éè¿­ä»£ä¿®æ­£è§£æ±ºç¿»èˆ¹å•é¡Œ", "affective_goal": "åŸ¹é¤Šåè„†å¼±çš„å·¥ç¨‹æ€ç¶­",
                    "hook_question": "ä»»å‹™ï¼šé€ ä¸€è‰˜åœ¨10ç´šå¼·é¢¨ä¸‹ä¸ç¿»çš„èˆ¹ã€‚",
                    "step1_student": "æ†‘ç›´è¦ºé€ èˆ¹(é€šå¸¸æœƒåšå¤§æ–¹å¸†)ã€‚",
                    "teacher_guide": "è®“å­¸ç”Ÿç¶“æ­·å¤±æ•—(Crash Test)ï¼Œå†å¼•å…¥ç‰©ç†åŸç†æ•‘æ´ã€‚",
                    "concept_detail": "å·¥ç¨‹é™åˆ¶ï¼šå¦‚ä½•åœ¨ç¶­æŒå‹•åŠ›(é¢ç©)çš„å‰æä¸‹æ¸›å°‘åŠ›çŸ©ï¼Ÿç­”æ¡ˆï¼šé™ä½å¹¾ä½•é‡å¿ƒã€‚",
                    "step2_student": "é€²è¡Œç¬¬ä¸€è¼ªæ¸¬è©¦(å…¨é«”ç¿»èˆ¹)ï¼Œç„¶å¾Œä¿®æ”¹è¨­è¨ˆã€‚",
                    "task_goal": "é€šéå¼·é¢¨æ¸¬è©¦ã€‚",
                    "materials": "çç æ¿ã€ç«¹ç±¤ã€ä¸ç¹”å¸ƒã€å·¥æ¥­æ‰‡ã€ç†±ç†”è† ã€‚",
                    "test_method": "é–‹å•Ÿå·¥æ¥­æ‰‡æœ€å¼·æª”ï¼Œå´å¹ã€‚",
                    "observation_focus": "èˆ¹æ˜¯å¦‚ä½•ç¿»çš„ï¼Ÿ(ç¬é–“çš„æ—‹è½‰è»¸)",
                    "reflection_guide": "å—å³¶ç¥–å…ˆä¹Ÿæ˜¯é€™æ¨£ã€è©¦ã€å‡ºä¾†çš„å—ï¼Ÿ(Trial and Error)",
                    "space_need": "å‰µå®¢æ•™å®¤ï¼Œéœ€å¤§æ°´æ§½ã€‚"
                },
                "Ver. C": {
                    "skill_goal": "è½‰è­¯é•·è€çš„èˆªæµ·æ™ºæ…§", "affective_goal": "å»ºç«‹æ–‡åŒ–è‡ªä¿¡",
                    "hook_question": "ç§‘å­¸æ˜¯è¥¿æ–¹çš„ç™¼æ˜å—ï¼Ÿ",
                    "step1_student": "é–±è®€é»‘æ½®èˆªæµ·æ•…äº‹ã€‚",
                    "teacher_guide": "å°‡éƒ¨è½èªå½™(é †é¢¨ã€å´é¢¨ã€å£“è‰™)å°æ‡‰åˆ°ç‰©ç†åè©ã€‚",
                    "concept_detail": "ç§‘å­¸æ™®ä¸–æ€§ï¼šä¸åŒæ–‡åŒ–ç”¨ä¸åŒèªè¨€æè¿°åŒä¸€å€‹ç‰©ç†çœŸç†ã€‚",
                    "step2_student": "è£½ä½œç¥ˆç¦æ¨¡å‹ã€‚",
                    "task_goal": "å®Œæˆä¸€è‰˜å…·æœ‰æ–‡åŒ–è±¡å¾µçš„èˆ¹ã€‚",
                    "materials": "è‡ªç„¶ç´ æã€å½©ç¹ªå·¥å…·ã€‚",
                    "test_method": "éœæ…‹å±•ç¤ºèˆ‡ä¸‹æ°´å„€å¼ã€‚",
                    "observation_focus": "èˆ¹èº«å½©ç¹ªèˆ‡åœ–é¨°çš„æ„ç¾©ã€‚",
                    "reflection_guide": "æˆ‘å€‘ç¾åœ¨å­¸ç†åŒ–ï¼Œæ˜¯ç‚ºäº†è®€æ‡‚ç¥–å…ˆçš„ç„¡å­—å¤©æ›¸ã€‚",
                    "space_need": "ä¸€èˆ¬æ•™å®¤ã€‚"
                }
            }
        },
        # ... ä¹å¹´ç´šå…¶ä»–ä¸»é¡Œ
    ]
}

# ==========================================
# 3. Streamlit ä»‹é¢é‚è¼¯ (UI)
# ==========================================
st.set_page_config(page_title="è·¨è¶Šé»‘æ½® æ•™æ¡ˆå¯¦é©—å®¤", page_icon="ğŸŒŠ", layout="wide")

# CSS å„ªåŒ–
st.markdown("""
<style>
    .stButton>button { border-radius: 20px; border: 2px solid #2E86C1; width: 100%; }
    h1 { color: #154360; }
    .stSuccess { background-color: #D4E6F1; }
</style>
""", unsafe_allow_html=True)

# Session State åˆå§‹åŒ–
if 'grade_index' not in st.session_state:
    st.session_state.grade_index = 0
if 'topic_index' not in st.session_state:
    st.session_state.topic_index = 0

def randomize_topic():
    # éš¨æ©Ÿé¸æ“‡ä¸»é¡Œç´¢å¼•
    # é€™è£¡ç°¡åŒ–é‚è¼¯ï¼Œå‡è¨­æ¯å€‹å¹´ç´šéƒ½æœ‰è³‡æ–™ï¼Œå¯¦éš›æ‡‰ç”¨å¯åŠ å¼·é˜²å‘†
    st.session_state.topic_index = random.randint(0, 100) # ç”¨å¤§æ•¸å­—å–é¤˜æ•¸å³å¯

# å´é‚Šæ¬„
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/2922/2922037.png", width=80)
    st.title("âš™ï¸ èª²ç¨‹æ§åˆ¶å°")
    st.markdown("---")
    
    # 1. é¸æ“‡å¹´ç´š
    grade_options = list(topics_db.keys())
    grade_select = st.selectbox("1. é¸æ“‡æ•™å­¸å°è±¡", grade_options)
    
    # 2. éš¨æ©Ÿä¸»é¡Œ
    st.markdown("### 2. ç”Ÿæˆä¸»é¡Œ")
    if st.button("ğŸ² éš¨æ©Ÿé‹ç®—æ–°ä¸»é¡Œ (Reroll)"):
        randomize_topic()
    
    # è¨ˆç®—ç•¶å‰ä¸»é¡Œ
    current_grade_topics = topics_db[grade_select]
    current_topic = current_grade_topics[st.session_state.topic_index % len(current_grade_topics)]
    
    st.success(f"å·²é–å®šï¼š{current_topic['name']}")
    
    # 3. é¸æ“‡é¢¨æ ¼
    st.markdown("### 3. é¸æ“‡é¢¨æ ¼")
    version_select = st.radio("Style", ["Ver. A æ¨™æº–æ¢ç©¶ç‰ˆ", "Ver. B ç¡¬æ´¾å¯¦ä½œç‰ˆ", "Ver. C æ·±åº¦æ–‡åŒ–ç‰ˆ"])
    
    st.markdown("---")
    st.caption("Engine: **è·¨è¶Šé»‘æ½® v9.0 (Full-Render)**")

# ä¸»ç•«é¢
st.markdown(f"# ğŸŒŠ è·¨è¶Šé»‘æ½®ï¼š{grade_select.split(' ')[0]}è©³ç´°æ•™æ¡ˆ")
st.markdown(f"### ğŸ¯ {current_topic['name']}")

# è³‡è¨Šå„€è¡¨æ¿
col1, col2, col3 = st.columns(3)
with col1:
    st.info(f"**æ ¸å¿ƒæ¦‚å¿µ**\n\n{current_topic['concept']}")
with col2:
    st.warning(f"**å°æ‡‰ç´ é¤Š**\n\n{current_topic['competency']}")
with col3:
    if "Ver. A" in version_select:
        st.metric("ç§‘å­¸å«é‡", "â­â­â­â­")
    elif "Ver. B" in version_select:
        st.metric("å¯¦ä½œå¼·åº¦", "ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥")
    else:
        st.metric("æ–‡åŒ–æ·±åº¦", "ğŸŒğŸŒğŸŒğŸŒ")

st.markdown("---")

# å‹•æ…‹ç”Ÿæˆå®Œæ•´æ•™æ¡ˆæ–‡æœ¬
full_lesson_plan = render_full_markdown(grade_select, current_topic, version_select)

# é¡¯ç¤ºèˆ‡ä¸‹è¼‰
tab1, tab2 = st.tabs(["ğŸ“„ æ•™æ¡ˆé è¦½", "ğŸ“¥ ä¸‹è¼‰æ­£å¼æ–‡ä»¶"])

with tab1:
    st.markdown(full_lesson_plan)

with tab2:
    st.success("âœ… å·²ç‚ºæ‚¨ç”Ÿæˆæ­£å¼ç‰ˆè©³æ¡ˆï¼ŒåŒ…å«å®Œæ•´æ•™å­¸æµç¨‹èˆ‡è©•é‡è¦æº–ã€‚")
    st.download_button(
        label=f"ğŸ“¥ ä¸‹è¼‰ {current_topic['name']} ({version_select[:6]}).md",
        data=full_lesson_plan,
        file_name=f"LessonPlan_{current_topic['name']}_{version_select[:6]}.md",
        mime="text/markdown",
        type="primary"
    )
